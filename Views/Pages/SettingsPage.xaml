<Page x:Class="DrugSearcher.Views.SettingsPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
      xmlns:viewModels="clr-namespace:DrugSearcher.ViewModels"
      xmlns:models="clr-namespace:DrugSearcher.Models"
      xmlns:converters="clr-namespace:DrugSearcher.Converters"
      xmlns:selectors="clr-namespace:DrugSearcher.Views.Selectors"
      xmlns:controls="clr-namespace:DrugSearcher.Views.Controls"
      xmlns:behaviors="clr-namespace:DrugSearcher.Behaviors"
      mc:Ignorable="d"
      d:DesignHeight="700" d:DesignWidth="900"
      d:DataContext="{d:DesignInstance viewModels:SettingsPageViewModel}"
      Title="设置">

    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />

        <!-- 反转布尔值转换器 -->
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter" />
        <converters:SafeDictionaryAccessConverter x:Key="SafeDictionaryAccessConverter" />
        <converters:ObjectToDoubleConverter x:Key="ObjectToDoubleConverter"/>
        <converters:HotKeyConverter x:Key="HotKeyConverter"/>
        <!-- 设置模板选择器 -->


        <!-- 设置卡片样式 -->
        <Style x:Key="FluentSettingsCardStyle" TargetType="Border">
            <Setter Property="behaviors:ThemeBehavior.Background" Value="{DynamicResource SecondaryBackgroundBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="0.8" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="16,12" />
            <Setter Property="Margin" Value="0,0,0,12" />
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="1" BlurRadius="6" Opacity="0.1" Color="Black" />
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 设置组样式 -->
        <Style x:Key="FluentSettingsGroupStyle" TargetType="StackPanel">
            <Setter Property="Margin" Value="0,0,0,24" />
        </Style>

        <!-- 设置组标题样式 -->
        <Style x:Key="SettingsGroupHeaderStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="18" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}" />
            <Setter Property="Margin" Value="0" />
        </Style>

        <!-- 设置项标题样式 -->
        <Style x:Key="SettingTitleStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <!-- 设置项描述样式 -->
        <Style x:Key="SettingDescriptionStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Foreground" Value="{DynamicResource SecondaryTextBrush}" />
            <Setter Property="TextWrapping" Value="Wrap" />
            <Setter Property="Margin" Value="0,4,10,0" />
            <Setter Property="LineHeight" Value="18" />
        </Style>

        <selectors:SettingTemplateSelector x:Key="SettingTemplateSelector">
            <!-- 开关模板 -->
            <selectors:SettingTemplateSelector.ToggleTemplate>
                <DataTemplate DataType="models:DynamicSettingItem">
                    <Border Style="{StaticResource FluentSettingsCardStyle}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{Binding DisplayName}" Style="{StaticResource SettingTitleStyle}" />
                                <TextBlock Text="{Binding Description}" Style="{StaticResource SettingDescriptionStyle}" />
                            </StackPanel>

                            <CheckBox Grid.Column="1"
                                      Style="{StaticResource FluentToggleSwitchStyle}"
                                      IsChecked="{Binding Value, Mode=TwoWay}"
                                      IsEnabled="{Binding IsReadOnly, Converter={StaticResource InverseBooleanConverter}}"
                                      Command="{Binding DataContext.UpdateSettingCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                      CommandParameter="{Binding}"
                                      VerticalAlignment="Center">
                            </CheckBox>
                        </Grid>
                    </Border>
                </DataTemplate>
            </selectors:SettingTemplateSelector.ToggleTemplate>

            <!-- 修复下拉框模板 -->
            <selectors:SettingTemplateSelector.ComboBoxTemplate>
                <DataTemplate DataType="models:DynamicSettingItem">
                    <Border Style="{StaticResource FluentSettingsCardStyle}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="200" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{Binding DisplayName}" Style="{StaticResource SettingTitleStyle}" />
                                <TextBlock Text="{Binding Description}"
                                           Style="{StaticResource SettingDescriptionStyle}" />
                            </StackPanel>

                            <ComboBox Grid.Column="1"
                                      Style="{StaticResource FluentComboBoxStyle}"
                                      ItemsSource="{Binding AdditionalData[ItemsSource]}"
                                      SelectedValue="{Binding Value, Mode=TwoWay}"
                                      IsEnabled="{Binding IsReadOnly, Converter={StaticResource InverseBooleanConverter}}"
                                      DisplayMemberPath="{Binding Path=AdditionalData, Converter={StaticResource SafeDictionaryAccessConverter}, ConverterParameter=DisplayMemberPath}"
                                      SelectedValuePath="{Binding Path=AdditionalData, Converter={StaticResource SafeDictionaryAccessConverter}, ConverterParameter=SelectedValuePath}"
                                      VerticalAlignment="Center">
                                <!-- 添加交互触发器 -->
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="SelectionChanged">
                                        <i:InvokeCommandAction
                                            Command="{Binding DataContext.UpdateSettingCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                            CommandParameter="{Binding}" />
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                            </ComboBox>
                        </Grid>
                    </Border>
                </DataTemplate>
            </selectors:SettingTemplateSelector.ComboBoxTemplate>
            <!-- 滑块模板 -->
            <selectors:SettingTemplateSelector.SliderTemplate>
                <DataTemplate DataType="models:DynamicSettingItem">
                    <Border Style="{StaticResource FluentSettingsCardStyle}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="200" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{Binding DisplayName}" Style="{StaticResource SettingTitleStyle}" />
                                <TextBlock Text="{Binding Description}"
                                           Style="{StaticResource SettingDescriptionStyle}" />
                            </StackPanel>

                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <Slider Grid.Column="0"
                                            Value="{Binding Value, Mode=TwoWay, Converter={StaticResource ObjectToDoubleConverter}}" 
                                            Minimum="{Binding Path=AdditionalData, Converter={StaticResource SafeDictionaryAccessConverter}, ConverterParameter=Minimum}"
                                            Maximum="{Binding Path=AdditionalData, Converter={StaticResource SafeDictionaryAccessConverter}, ConverterParameter=Maximum}"
                                            TickFrequency="{Binding Path=AdditionalData, Converter={StaticResource SafeDictionaryAccessConverter}, ConverterParameter=TickFrequency}"
                                            IsSnapToTickEnabled="True"
                                            IsEnabled="{Binding IsReadOnly, Converter={StaticResource InverseBooleanConverter}}"
                                            VerticalAlignment="Center"
                                            Margin="0,0,12,0">

                                        <!-- 使用值变更事件而不是点击事件 -->
                                        <i:Interaction.Triggers>
                                            <i:EventTrigger EventName="ValueChanged">
                                                <i:InvokeCommandAction Command="{Binding DataContext.UpdateSettingCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                                       CommandParameter="{Binding}"/>
                                            </i:EventTrigger>
                                        </i:Interaction.Triggers>
                                    </Slider>

                                    <Border Grid.Column="1"
                                            Background="{DynamicResource SurfaceBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="4"
                                            Padding="8,4"
                                            MinWidth="40">
                                        <TextBlock Text="{Binding Value}"
                                                   Foreground="{DynamicResource PrimaryTextBrush}"
                                                   TextAlignment="Center" />
                                    </Border>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </Border>
                </DataTemplate>
            </selectors:SettingTemplateSelector.SliderTemplate>

            <!-- 文本框模板 -->
            <selectors:SettingTemplateSelector.TextBoxTemplate>
                <DataTemplate DataType="models:DynamicSettingItem">
                    <Border Style="{StaticResource FluentSettingsCardStyle}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="200" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{Binding DisplayName}" Style="{StaticResource SettingTitleStyle}" />
                                <TextBlock Text="{Binding Description}"
                                           Style="{StaticResource SettingDescriptionStyle}" />
                            </StackPanel>

                            <TextBox Grid.Column="1"
                                     Style="{StaticResource BaseTextBoxStyle}"
                                     Text="{Binding Value, Mode=TwoWay}"
                                     IsEnabled="{Binding IsReadOnly, Converter={StaticResource InverseBooleanConverter}}"
                                     VerticalAlignment="Center">
                                <TextBox.InputBindings>
                                    <KeyBinding Key="Enter"
                                                Command="{Binding DataContext.UpdateSettingCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                CommandParameter="{Binding}" />
                                </TextBox.InputBindings>
                            </TextBox>
                        </Grid>
                    </Border>
                </DataTemplate>
            </selectors:SettingTemplateSelector.TextBoxTemplate>

            <!-- 按钮模板 -->
            <selectors:SettingTemplateSelector.ButtonTemplate>
                <DataTemplate DataType="models:DynamicSettingItem">
                    <Border Style="{StaticResource FluentSettingsCardStyle}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{Binding DisplayName}" Style="{StaticResource SettingTitleStyle}" />
                                <TextBlock Text="{Binding Description}"
                                           Style="{StaticResource SettingDescriptionStyle}" />
                            </StackPanel>

                            <Button Grid.Column="1"
                                    Content="{Binding Value}"
                                    Style="{StaticResource FluentSecondaryButtonStyle}"
                                    Command="{Binding DataContext.UpdateSettingCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                    CommandParameter="{Binding}"
                                    IsEnabled="{Binding IsReadOnly, Converter={StaticResource InverseBooleanConverter}}"
                                    VerticalAlignment="Center" />
                        </Grid>
                    </Border>
                </DataTemplate>
            </selectors:SettingTemplateSelector.ButtonTemplate>

            <!-- 快捷键模板 -->
            <selectors:SettingTemplateSelector.HotKeyTemplate>
                <DataTemplate DataType="models:DynamicSettingItem">
                    <Border Style="{StaticResource FluentSettingsCardStyle}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="200" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{Binding DisplayName}" Style="{StaticResource SettingTitleStyle}" />
                                <TextBlock Text="{Binding Description}"
                                           Style="{StaticResource SettingDescriptionStyle}" />
                            </StackPanel>

                            <controls:HotKeyInputControl Grid.Column="1"
                                                         Value="{Binding Value, Mode=TwoWay, Converter={StaticResource HotKeyConverter}}"
                                                         Command="{Binding DataContext.UpdateHotKeySettingCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                         CommandParameter="{Binding}"
                                                         IsEnabled="{Binding IsReadOnly, Converter={StaticResource InverseBooleanConverter}}"
                                                         VerticalAlignment="Center" />
                        </Grid>
                    </Border>
                </DataTemplate>
            </selectors:SettingTemplateSelector.HotKeyTemplate>
        </selectors:SettingTemplateSelector>
    </Page.Resources>

    <Grid behaviors:ThemeBehavior.Background="{DynamicResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- 页面头部 -->
        <Border Grid.Row="0"
                behaviors:ThemeBehavior.Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="32,24">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0">
                    <TextBlock Text="设置"
                               FontSize="28"
                               FontWeight="Bold"
                               Foreground="{DynamicResource PrimaryTextBrush}" />
                    <TextBlock Text="个性化您的应用体验"
                               FontSize="14"
                               Foreground="{DynamicResource SecondaryTextBrush}"
                               Margin="0,4,0,0" />
                </StackPanel>

                <TextBox Grid.Column="1"
                         Width="280" VerticalAlignment="Center"
                         Style="{StaticResource BaseTextBoxStyle}"
                         Text="{Binding SearchText, Mode=TwoWay}"
                         Tag="搜索设置...">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Escape" Command="{Binding ClearSearchCommand}" />
                    </TextBox.InputBindings>
                </TextBox>
            </Grid>
        </Border>

        <!-- 主要内容区域 -->
        <ScrollViewer Grid.Row="1"
                      VerticalScrollBarVisibility="Auto"
                      Padding="32,24"
                      Background="Transparent">
            <StackPanel MaxWidth="800" HorizontalAlignment="Center">

                <!-- 加载指示器 -->
                <ProgressBar IsIndeterminate="True"
                             Height="3"
                             Margin="0,0,0,24"
                             Background="Transparent"
                             Foreground="{DynamicResource PrimaryBrush}"
                             Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}" />

                <!-- 状态消息 -->
                <Border Background="{DynamicResource PrimaryBrush}"
                        CornerRadius="6"
                        Padding="16,12"
                        Margin="0,0,0,24"
                        Visibility="{Binding StatusMessage, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="{Binding StatusMessage}"
                               Foreground="White"
                               FontSize="14"
                               FontWeight="Medium" />
                </Border>

                <!-- 动态设置组 -->
                <ItemsControl ItemsSource="{Binding FilteredGroups}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="models:DynamicSettingGroup">
                            <StackPanel Style="{StaticResource FluentSettingsGroupStyle}">
                                <!-- 分组标题 -->
                                <Grid Margin="0,0,0,16">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                                        <TextBlock Text="{Binding Icon}"
                                                   FontFamily="{DynamicResource IconFont}"
                                                   FontSize="24"
                                                   Foreground="{DynamicResource PrimaryBrush}"
                                                   VerticalAlignment="Center"
                                                   Margin="0,0,12,0" />
                                        <TextBlock Text="{Binding DisplayName}"
                                                   Style="{StaticResource SettingsGroupHeaderStyle}"
                                                   VerticalAlignment="Center" />
                                    </StackPanel>

                                    <Button Grid.Column="1"
                                            Content="重置分类"
                                            Style="{StaticResource FluentSecondaryButtonStyle}"
                                            Command="{Binding DataContext.ResetGroupCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                            CommandParameter="{Binding Name}"
                                            Visibility="{Binding CanReset, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                </Grid>

                                <!-- 设置项 -->
                                <ItemsControl ItemsSource="{Binding Items}">
                                    <ItemsControl.ItemTemplateSelector>
                                        <StaticResource ResourceKey="SettingTemplateSelector" />
                                    </ItemsControl.ItemTemplateSelector>
                                </ItemsControl>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- 数据管理 -->
                <StackPanel Style="{StaticResource FluentSettingsGroupStyle}">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                        <TextBlock Text="&#xe620;"
                                   FontFamily="{DynamicResource IconFont}"
                                   FontSize="24"
                                   Foreground="{DynamicResource PrimaryBrush}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,12,0" />
                        <TextBlock Text="数据管理" Style="{StaticResource SettingsGroupHeaderStyle}" />
                    </StackPanel>

                    <!-- 导入导出设置 -->
                    <Border Style="{StaticResource FluentSettingsCardStyle}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="备份与恢复" Style="{StaticResource SettingTitleStyle}" />
                                <TextBlock Text="导出当前设置到文件进行备份，或从备份文件中恢复设置。"
                                           Style="{StaticResource SettingDescriptionStyle}" />
                            </StackPanel>

                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Content="导出设置"
                                        Style="{StaticResource FluentSecondaryButtonStyle}"
                                        Command="{Binding ExportSettingsCommand}"
                                        Margin="0,0,8,0" />
                                <Button Content="导入设置"
                                        Style="{StaticResource FluentSecondaryButtonStyle}"
                                        Command="{Binding ImportSettingsCommand}" />
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- 重置所有设置 -->
                    <Border Style="{StaticResource FluentSettingsCardStyle}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="重置所有设置" Style="{StaticResource SettingTitleStyle}" />
                                <TextBlock Text="将所有设置恢复为默认值。此操作不可撤销，请谨慎操作。"
                                           Style="{StaticResource SettingDescriptionStyle}" />
                            </StackPanel>

                            <Button Grid.Column="1"
                                    Content="重置所有"
                                    Style="{StaticResource FluentSecondaryButtonStyle}"
                                    Command="{Binding ResetAllSettingsCommand}"
                                    Foreground="#D13438"
                                    BorderBrush="#D13438" />
                        </Grid>
                    </Border>
                </StackPanel>

                <!-- 底部间距 -->
                <Border Height="32" />
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>