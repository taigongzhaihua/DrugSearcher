<Page x:Class="DrugSearcher.Views.HomePage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
      xmlns:markdig="clr-namespace:Markdig.Wpf;assembly=Markdig.Wpf"
      xmlns:viewModels="clr-namespace:DrugSearcher.ViewModels"
      xmlns:converters="clr-namespace:DrugSearcher.Converters"
      xmlns:behaviors="clr-namespace:DrugSearcher.Behaviors"
      xmlns:models="clr-namespace:DrugSearcher.Models"
      xmlns:selectors="clr-namespace:DrugSearcher.Views.Selectors"
      mc:Ignorable="d"
      d:DesignHeight="600" d:DesignWidth="1000" d:DataContext="{d:DesignInstance viewModels:HomePageViewModel}"
      Title="药物查询"
      x:Name="Page">

    <Page.Resources>
        <Style TargetType="ListBoxItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border x:Name="Border"
                                Background="{DynamicResource CardBackgroundBrush}"
                                CornerRadius="4" Margin="4"
                                BorderThickness="1"
                                BorderBrush="{DynamicResource CardBorderBrush}">
                            <Grid>
                                <ContentPresenter HorizontalAlignment="Stretch" />
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="BorderBrush"
                                        Value="{DynamicResource PrimaryBrush}" />
                                <Setter TargetName="Border" Property="Effect"
                                        Value="{DynamicResource HoverShadowEffect}" />
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Border" Property="Background"
                                        Value="{DynamicResource InfoCardBackgroundBrush}" />
                                <Setter TargetName="Border" Property="BorderBrush"
                                        Value="{DynamicResource PrimaryBrush}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 转换器 -->
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter" />
        <converters:ListToStringConverter x:Key="ListToStringConverter" />

        <!-- 参数模板选择器 -->
        <selectors:DosageParameterTemplateSelector x:Key="ParameterTemplateSelector">
            <!-- 文本类型模板 -->
            <selectors:DosageParameterTemplateSelector.TextTemplate>
                <DataTemplate DataType="{x:Type models:DosageParameter}">
                    <Border BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="10"
                            Margin="0,0,15,10"
                            Background="{DynamicResource CardBackgroundBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" MinWidth="100" />
                                <ColumnDefinition Width="*" MinWidth="150" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition />
                            </Grid.ColumnDefinitions>

                            <!-- 参数名称 -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock Text="{Binding DisplayName}" Style="{DynamicResource DefaultTextStyle}"
                                           FontWeight="SemiBold" />
                                <TextBlock Text="*"
                                           FontSize="10"
                                           Margin="3,0,0,5"
                                           VerticalAlignment="Top"
                                           Foreground="{DynamicResource ErrorBrush}"
                                           Visibility="{Binding IsRequired, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            </StackPanel>

                            <!-- 文本输入框 -->
                            <TextBox Grid.Row="0" Grid.Column="1"
                                     Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{DynamicResource BaseTextBoxStyle}"
                                     Margin="10,0, 0,0"
                                     VerticalAlignment="Center"
                                     Tag="{Binding Description}" />

                            <!-- 单位 -->
                            <TextBlock Grid.Row="0" Grid.Column="2"
                                       Text="{Binding Unit}"
                                       FontSize="14"
                                       VerticalAlignment="Center"
                                       Margin="10,0,0,0"
                                       Foreground="{DynamicResource SecondaryTextBrush}"
                                       Visibility="{Binding Unit, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            <!-- 说明文本 -->
                            <TextBlock Grid.Column="3"
                                       Text="&#xe63f;"
                                       FontSize="14" Margin="5,0,0,0"
                                       VerticalAlignment="Center" HorizontalAlignment="Right"
                                       Foreground="{DynamicResource InfoTextBrush}"
                                       FontFamily="{DynamicResource IconFont}"
                                       ToolTip="{Binding Description}"
                                       Visibility="{Binding Description, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Foreground"
                                                        Value="{DynamicResource InfoLightBrush}">
                                                </Setter>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </Border>
                </DataTemplate>
            </selectors:DosageParameterTemplateSelector.TextTemplate>

            <!-- 数字类型模板 -->
            <selectors:DosageParameterTemplateSelector.NumberTemplate>
                <DataTemplate DataType="{x:Type models:DosageParameter}">
                    <Border BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="10"
                            Margin="0,0,15,10"
                            Background="{DynamicResource CardBackgroundBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" MinWidth="40" />
                                <ColumnDefinition Width="*" MinWidth="40" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition />
                            </Grid.ColumnDefinitions>

                            <!-- 参数名称 -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock Text="{Binding DisplayName}" Style="{DynamicResource DefaultTextStyle}"
                                           FontWeight="SemiBold" />
                                <TextBlock Text="*"
                                           FontSize="10"
                                           Margin="3,0,0,5"
                                           VerticalAlignment="Top"
                                           Foreground="{DynamicResource ErrorBrush}"
                                           Visibility="{Binding IsRequired, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            </StackPanel>

                            <!-- 数字输入框 -->
                            <TextBox Grid.Row="0" Grid.Column="1"
                                     Text="{Binding Value, UpdateSourceTrigger=PropertyChanged,ValidatesOnDataErrors=True}"
                                     Style="{DynamicResource NumericTextBoxStyle}"
                                     Margin="10,0,0,0"
                                     VerticalAlignment="Center"
                                     Tag="{Binding Description}">
                                <i:Interaction.Behaviors>
                                    <behaviors:NumericInputBehavior />
                                </i:Interaction.Behaviors>
                            </TextBox>

                            <!-- 单位 -->
                            <TextBlock Grid.Row="0" Grid.Column="2"
                                       Text="{Binding Unit}"
                                       FontSize="14"
                                       VerticalAlignment="Center"
                                       Margin="10,0,0,0"
                                       Foreground="{DynamicResource SecondaryTextBrush}"
                                       Visibility="{Binding Unit, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            <!-- 说明文本 -->
                            <TextBlock Grid.Column="3"
                                       Text="&#xe63f;"
                                       FontSize="14" Margin="5,0,0,0"
                                       VerticalAlignment="Center" HorizontalAlignment="Right"
                                       Foreground="{DynamicResource InfoTextBrush}"
                                       FontFamily="{DynamicResource IconFont}"
                                       ToolTip="{Binding Description}"
                                       Visibility="{Binding Description, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Foreground"
                                                        Value="{DynamicResource InfoLightBrush}">
                                                </Setter>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </Border>
                </DataTemplate>
            </selectors:DosageParameterTemplateSelector.NumberTemplate>

            <!-- 布尔类型模板 -->
            <selectors:DosageParameterTemplateSelector.BooleanTemplate>
                <DataTemplate DataType="{x:Type models:DosageParameter}">
                    <Border BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="10"
                            Margin="0,0,15,10"
                            Background="{DynamicResource CardBackgroundBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" MinWidth="40" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition />
                            </Grid.ColumnDefinitions>

                            <!-- 参数名称 -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center"
                                        Margin="0,0,5,0">
                                <TextBlock Text="{Binding DisplayName}" Style="{DynamicResource DefaultTextStyle}"
                                           FontWeight="SemiBold" />
                                <TextBlock Text="*"
                                           FontSize="10"
                                           Margin="3,0,0,5"
                                           VerticalAlignment="Top"
                                           Foreground="{DynamicResource ErrorBrush}"
                                           Visibility="{Binding IsRequired, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            </StackPanel>

                            <!-- 开关 -->
                            <CheckBox Grid.Row="0" Grid.Column="1"
                                      IsChecked="{Binding Value}"
                                      Style="{DynamicResource FluentToggleSwitchStyle}"
                                      Margin="10,0"
                                      VerticalAlignment="Center"
                                      ToolTip="{Binding Description}" />

                            <TextBlock Grid.Row="0" Grid.Column="2"
                                       FontSize="12" VerticalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Value}" Value="True">
                                                <Setter Property="Text" Value="是" />
                                                <Setter Property="Foreground"
                                                        Value="{DynamicResource SuccessTextBrush}" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Value}" Value="False">
                                                <Setter Property="Text" Value="否" />
                                                <Setter Property="Foreground"
                                                        Value="{DynamicResource SecondaryTextBrush}" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            <!-- 说明文本 -->
                            <TextBlock Grid.Column="3"
                                       Text="&#xe63f;"
                                       FontSize="14" Margin="5,0,0,0"
                                       VerticalAlignment="Center" HorizontalAlignment="Right"
                                       Foreground="{DynamicResource InfoTextBrush}"
                                       FontFamily="{DynamicResource IconFont}"
                                       ToolTip="{Binding Description}"
                                       Visibility="{Binding Description, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Foreground"
                                                        Value="{DynamicResource InfoLightBrush}">
                                                </Setter>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </Border>
                </DataTemplate>
            </selectors:DosageParameterTemplateSelector.BooleanTemplate>

            <!-- 选择类型模板 -->
            <selectors:DosageParameterTemplateSelector.SelectionTemplate>
                <DataTemplate DataType="{x:Type models:DosageParameter}">
                    <Border BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="10"
                            Margin="0,0,15,10"
                            Background="{DynamicResource CardBackgroundBrush}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" MinWidth="40" />
                                <ColumnDefinition Width="*" MinWidth="40" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition />
                            </Grid.ColumnDefinitions>

                            <!-- 参数名称 -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock Text="{Binding DisplayName}" Style="{DynamicResource DefaultTextStyle}"
                                           FontWeight="SemiBold" />
                                <TextBlock Text="*"
                                           FontSize="10"
                                           Margin="3,0,0,5"
                                           VerticalAlignment="Top"
                                           Foreground="{DynamicResource ErrorBrush}"
                                           Visibility="{Binding IsRequired, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            </StackPanel>

                            <!-- 下拉选择框 -->
                            <ComboBox Grid.Row="0" Grid.Column="1"
                                      ItemsSource="{Binding Options}"
                                      SelectedItem="{Binding Value}"
                                      Style="{DynamicResource FluentComboBoxStyle}"
                                      Margin="10,0,0,0"
                                      VerticalAlignment="Center"
                                      ToolTip="{Binding Description}" />

                            <!-- 单位 -->
                            <TextBlock Grid.Row="0" Grid.Column="2"
                                       Text="{Binding Unit}"
                                       FontSize="14"
                                       VerticalAlignment="Center"
                                       Margin="10,0,5,0"
                                       Foreground="{DynamicResource SecondaryTextBrush}"
                                       Visibility="{Binding Unit, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            <!-- 说明文本 -->
                            <TextBlock Grid.Column="3"
                                       Text="&#xe63f;"
                                       FontSize="14" Margin="5,0,0,0"
                                       VerticalAlignment="Center" HorizontalAlignment="Right"
                                       Foreground="{DynamicResource InfoTextBrush}"
                                       FontFamily="{DynamicResource IconFont}"
                                       ToolTip="{Binding Description}"
                                       Visibility="{Binding Description, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Foreground"
                                                        Value="{DynamicResource InfoLightBrush}">
                                                </Setter>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </Border>
                </DataTemplate>
            </selectors:DosageParameterTemplateSelector.SelectionTemplate>
        </selectors:DosageParameterTemplateSelector>


        <!-- 新增：TabItem 内容模板 -->
        <DataTemplate x:Key="TabContentTemplate" DataType="{x:Type viewModels:TabItemViewModel}">
            <Grid>
                <!-- 加载中提示 -->
                <StackPanel HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <ProgressBar Width="100"
                                 Height="20"
                                 IsIndeterminate="True"
                                 Margin="0,0,0,10" />
                    <TextBlock Text="正在加载内容..." Style="{DynamicResource DefaultTextStyle}"
                               Foreground="{DynamicResource SecondaryTextBrush}" />
                </StackPanel>

                <!-- 实际内容 -->
                <markdig:MarkdownViewer Markdown="{Binding Content}"
                                        Background="Transparent"
                                        MaxWidth="900"
                                        Visibility="{Binding IsLoading, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
            </Grid>
        </DataTemplate>

        <!-- 特殊的用法用量标签页模板 -->
        <DataTemplate x:Key="DosageTabContentTemplate" DataType="{x:Type viewModels:TabItemViewModel}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- 加载中提示 -->
                <StackPanel Grid.Row="0"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <ProgressBar Width="100"
                                 Height="20"
                                 IsIndeterminate="True"
                                 Margin="0,0,0,10" />
                    <TextBlock Text="正在加载内容..."
                               Foreground="{DynamicResource SecondaryTextBrush}" />
                </StackPanel>

                <!-- 原有的用法用量说明 -->
                <markdig:MarkdownViewer Grid.Row="0"
                                        Markdown="{Binding Content}"
                                        Background="Transparent"
                                        MaxWidth="900"
                                        Visibility="{Binding IsLoading, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
            </Grid>
        </DataTemplate>

        <!-- TabItem 内容选择器 -->
        <selectors:TabContentTemplateSelector x:Key="TabContentSelector"
                                              DefaultTemplate="{StaticResource TabContentTemplate}"
                                              DosageTemplate="{StaticResource DosageTabContentTemplate}" />
    </Page.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- 搜索区域 -->
        <Border Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
                behaviors:ThemeBehavior.Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource CardBorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="20"
                Margin="16,0,16,16"
                Effect="{DynamicResource CardShadowEffect}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- 搜索框和按钮 -->
                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- 搜索输入框 -->
                    <TextBox Grid.Column="0"
                             Text="{Binding SearchTerm, UpdateSourceTrigger=PropertyChanged}"
                             Tag="请输入药物名称、通用名或批准文号"
                             Style="{DynamicResource BaseTextBoxStyle}">
                        <i:Interaction.Behaviors>
                            <behaviors:KeyDownBehavior Key="Enter" Command="{Binding SearchCommand}" />
                        </i:Interaction.Behaviors>
                    </TextBox>

                    <!-- 搜索按钮 -->
                    <Button Grid.Column="1"
                            Content="搜索"
                            Style="{DynamicResource BaseButtonStyle}"
                            Margin="10,0,0,0"
                            Command="{Binding SearchCommand}"
                            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                </Grid>

                <!-- 数据源选择 -->
                <StackPanel Grid.Row="1"
                            Orientation="Horizontal"
                            Margin="0,15,0,0">
                    <CheckBox Content="本地数据库"
                              IsChecked="{Binding IsLocalDbEnabled}"
                              Margin="0,0,20,0"
                              Foreground="{DynamicResource PrimaryTextBrush}" />
                    <CheckBox Content="在线数据"
                              IsChecked="{Binding IsOnlineEnabled}"
                              Margin="0,0,20,0"
                              Foreground="{DynamicResource PrimaryTextBrush}" />
                    <TextBlock Text="注: 在线数据包含本地缓存和实时爬取数据"
                               FontSize="11"
                               Foreground="{DynamicResource TertiaryTextBrush}"
                               VerticalAlignment="Center" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- 修改结果列表部分 -->
        <Border Grid.Row="1" Grid.Column="0"
                behaviors:ThemeBehavior.Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource CardBorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Margin="16,0,8,16"
                ClipToBounds="False"
                Effect="{DynamicResource CardShadowEffect}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- 结果统计 -->
                <Border Grid.Row="0"
                        Background="{DynamicResource PrimaryThemedCardBackgroundBrush}"
                        Padding="15,10"
                        CornerRadius="7,7,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                            <TextBlock Text="{Binding ResultCount}"
                                       Foreground="{DynamicResource PrimaryThemedCardForegroundBrush}"
                                       FontWeight="SemiBold" />
                            <TextBlock Text="{Binding SearchStatus}"
                                       Foreground="{DynamicResource Heading4Brush}"
                                       Margin="20,0,0,0" />
                        </StackPanel>

                        <TextBlock Grid.Column="1"
                                   Text="{Binding PageInfo}"
                                   Foreground="{DynamicResource Heading6Brush}"
                                   FontSize="12" />
                    </Grid>
                </Border>

                <!-- 结果列表 -->
                <ListBox Grid.Row="1" ItemsSource="{Binding SearchResults}"
                         SelectedItem="{Binding SelectedDrug}"
                         Background="Transparent"
                         BorderThickness="0"
                         Width="380">
                    <i:Interaction.Triggers>
                        <i:EventTrigger EventName="SelectionChanged">
                            <i:InvokeCommandAction Command="{Binding SelectDrugCommand}"
                                                   CommandParameter="{Binding SelectedDrug}" />
                        </i:EventTrigger>
                    </i:Interaction.Triggers>
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="{x:Type models:UnifiedDrugSearchResult}">
                            <Grid Margin="10,5">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!-- 药物名称 -->
                                <TextBlock Grid.Column="0" Grid.Row="0"
                                           Text="{Binding DrugInfo.DisplayName}"
                                           FontWeight="SemiBold"
                                           FontSize="14" LineHeight="18"
                                           Foreground="{DynamicResource PrimaryTextBrush}" />

                                <!-- 数据源标识 -->
                                <Border Grid.Column="1" Grid.Row="0"
                                        Background="{Binding DrugInfo.DataSourceColor}"
                                        CornerRadius="9" Padding="16,2"
                                        VerticalAlignment="Center" HorizontalAlignment="Right">
                                    <TextBlock Text="{Binding DrugInfo.DataSourceText}"
                                               FontSize="12" LineHeight="Auto" VerticalAlignment="Center"
                                               Foreground="White" />
                                </Border>

                                <!-- 规格和制造商 -->
                                <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                      HorizontalAlignment="Stretch"
                                      Margin="0,3,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="3*" />
                                        <ColumnDefinition Width="5*" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding DrugInfo.Specification}"
                                               FontSize="12" LineHeight="18"
                                               Foreground="{DynamicResource SecondaryTextBrush}"
                                               HorizontalAlignment="Left"
                                               MaxWidth="120"
                                               TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" />
                                    <TextBlock Grid.Column="1"
                                               Text="{Binding DrugInfo.Manufacturer}"
                                               FontSize="12" LineHeight="18"
                                               Foreground="{DynamicResource SecondaryTextBrush}"
                                               HorizontalAlignment="Right"
                                               MaxWidth="200"
                                               TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" />
                                </Grid>

                                <!-- 匹配信息 -->
                                <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                            Orientation="Horizontal"
                                            Margin="0,3,0,0">
                                    <TextBlock Text="{Binding MatchScore, StringFormat=匹配度: {0:P1}}"
                                               FontSize="10" LineHeight="14"
                                               Foreground="{DynamicResource AccentBrush}" />
                                    <TextBlock Text=" | "
                                               FontSize="10" LineHeight="14"
                                               Foreground="{DynamicResource DividerBrush}"
                                               Margin="5,0" />
                                    <TextBlock FontSize="10" LineHeight="14"
                                               Foreground="{DynamicResource TertiaryTextBrush}">
                                        <TextBlock.Text>
                                            <MultiBinding StringFormat="匹配: {0}">
                                                <Binding Path="MatchedFields"
                                                         Converter="{StaticResource ListToStringConverter}" />
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>


                <!-- 分页控件 -->
                <Border Grid.Row="2"
                        Background="{DynamicResource PrimaryThemedCardBackgroundBrush}"
                        Padding="10"
                        Visibility="{Binding TotalPages, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!-- 上一页按钮 -->
                        <Button Grid.Column="0"
                                Content="上一页"
                                Command="{Binding LoadPreviousPageCommand}"
                                IsEnabled="{Binding HasPreviousPage}"
                                Style="{DynamicResource BaseButtonStyle}"
                                Padding="10,5" />

                        <!-- 页码信息 -->
                        <StackPanel Grid.Column="1"
                                    Orientation="Horizontal"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center">
                            <TextBlock Text="第 "
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource SecondaryTextBrush}" />
                            <TextBlock Text="{Binding CurrentPage}"
                                       TextAlignment="Center"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource SecondaryTextBrush}">
                            </TextBlock>
                            <TextBlock Text=" / "
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource SecondaryTextBrush}" />
                            <TextBlock Text="{Binding TotalPages}"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource SecondaryTextBrush}" />
                            <TextBlock Text=" 页"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource SecondaryTextBrush}" />
                        </StackPanel>

                        <!-- 下一页按钮 -->
                        <Button Grid.Column="2"
                                Content="下一页"
                                Command="{Binding LoadNextPageCommand}"
                                IsEnabled="{Binding HasNextPage}"
                                Style="{DynamicResource BaseButtonStyle}"
                                Padding="10,5" />
                    </Grid>
                </Border>

                <!-- 加载指示器 -->
                <ProgressBar Grid.Row="3"
                             IsIndeterminate="True"
                             Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                             Height="4" />

                <!-- 加载更多指示器 -->
                <Border Grid.Row="1"
                        Background="{DynamicResource CardBackgroundBrush}"
                        Opacity="0.8"
                        Visibility="{Binding IsLoadingMore, Converter={StaticResource BooleanToVisibilityConverter}}"
                        VerticalAlignment="Bottom"
                        Height="50">
                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center">
                        <ProgressBar Width="20"
                                     Height="20"
                                     IsIndeterminate="True"
                                     Margin="0,0,10,0" />
                        <TextBlock Text="正在加载更多..."
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource PrimaryTextBrush}" />
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- 药物详情显示 -->
        <Border Grid.Row="1" Grid.Column="1"
                behaviors:ThemeBehavior.Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource CardBorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Margin="8,0,16,16"
                Effect="{DynamicResource CardShadowEffect}"
                Visibility="{Binding IsDetailPanelVisible, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
            <!-- 默认提示 -->
            <TextBlock Text="请在左侧搜索并选择药物以查看详细信息"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource SecondaryTextBrush}"
                       FontSize="16"
                       Margin="0,100,0,0" />

        </Border>
        <ScrollViewer Grid.Row="1" Grid.Column="1" VerticalScrollBarVisibility="Auto"
                      Padding="8,0,16,16"
                      Visibility="{Binding IsDetailPanelVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel>
                <!-- 药物详情内容 -->
                <StackPanel>
                    <Border behaviors:ThemeBehavior.Background="{DynamicResource CardBackgroundBrush}"
                            BorderBrush="{DynamicResource CardBorderBrush}"
                            BorderThickness="1"
                            CornerRadius="8"
                            Margin="0,0,0,10"
                            Padding="16"
                            Effect="{DynamicResource CardShadowEffect}">
                        <!-- 基本信息 -->


                        <StackPanel Margin="0,0,0,20"
                                    >
                            <TextBlock Text="基本信息"
                                       FontSize="20"
                                       FontWeight="Bold"
                                       Foreground="{DynamicResource Heading3Brush}"
                                       Margin="0,0,0,15" />
                            <StackPanel Orientation="Horizontal" >
                                <TextBlock Width="120"
                                           Visibility="{Binding DrugName,Converter={StaticResource BooleanToVisibilityConverter}}"
                                           Text="药品名称:"
                                           FontWeight="SemiBold"
                                           Style="{DynamicResource DefaultTextStyle}"
                                           Margin="0,5,0,0" />
                                <TextBlock
                                    Visibility="{Binding DrugName,Converter={StaticResource BooleanToVisibilityConverter}}"
                                    Text="{Binding DrugName}"
                                    Style="{DynamicResource DefaultTextStyle}"
                                    TextWrapping="Wrap"
                                    Margin="0,5,0,0" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal"  >
                                <TextBlock Width="120"
                                           Visibility="{Binding ApprovalNumber,Converter={StaticResource BooleanToVisibilityConverter}}"
                                           Text="批准文号:"
                                           FontWeight="SemiBold"
                                           Style="{DynamicResource DefaultTextStyle}"
                                           Margin="0,5,0,0" />
                                <TextBlock
                                    Visibility="{Binding ApprovalNumber,Converter={StaticResource BooleanToVisibilityConverter}}"
                                    Text="{Binding ApprovalNumber}"
                                    Style="{DynamicResource DefaultTextStyle}"
                                    TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
                                    Margin="0,5,0,0" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" >
                                <TextBlock Width="120"
                                           Visibility="{Binding GenericName,Converter={StaticResource BooleanToVisibilityConverter}}"
                                           Text="通用名称:"
                                           FontWeight="SemiBold"
                                           Style="{DynamicResource DefaultTextStyle}"
                                           Margin="0,5,0,0" />
                                <TextBlock
                                    Visibility="{Binding GenericName,Converter={StaticResource BooleanToVisibilityConverter}}"
                                    Text="{Binding GenericName}"
                                    Style="{DynamicResource DefaultTextStyle}"
                                    Margin="0,5,0,0"
                                    TextWrapping="Wrap" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Width="120"
                                           Visibility="{Binding TradeName,Converter={StaticResource BooleanToVisibilityConverter}}"
                                           Text="商品名称:"
                                           FontWeight="SemiBold"
                                           Style="{DynamicResource DefaultTextStyle}"
                                           Margin="0,5,0,0" />
                                <TextBlock
                                    Visibility="{Binding TradeName,Converter={StaticResource BooleanToVisibilityConverter}}"
                                    Text="{Binding TradeName}"
                                    Style="{DynamicResource DefaultTextStyle}"
                                    Margin="0,5,0,0"
                                    TextWrapping="Wrap" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Width="120"
                                           Visibility="{Binding ManufacturerInfo,Converter={StaticResource BooleanToVisibilityConverter}}"
                                           Text="生产厂家:"
                                           FontWeight="SemiBold"
                                           Style="{DynamicResource DefaultTextStyle}"
                                           Margin="0,5,0,0" />
                                <TextBlock
                                    Visibility="{Binding ManufacturerInfo,Converter={StaticResource BooleanToVisibilityConverter}}"
                                    Text="{Binding ManufacturerInfo}"
                                    Style="{DynamicResource DefaultTextStyle}"
                                    Margin="0,5,0,0"
                                    TextWrapping="Wrap" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Width="120"
                                           Visibility="{Binding Specification,Converter={StaticResource BooleanToVisibilityConverter}}"
                                           Text="规格:"
                                           FontWeight="SemiBold"
                                           Style="{DynamicResource DefaultTextStyle}"
                                           Margin="0,5,0,0" />
                                <TextBlock
                                    Visibility="{Binding Specification,Converter={StaticResource BooleanToVisibilityConverter}}"
                                    Text="{Binding Specification}"
                                    Style="{DynamicResource DefaultTextStyle}"
                                    Margin="0,5,0,0"
                                    TextWrapping="Wrap" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Width="120"
                                           Text="数据来源:"
                                           FontWeight="SemiBold"
                                           Style="{DynamicResource DefaultTextStyle}"
                                           Margin="0,5,0,0" />
                                <StackPanel Orientation="Horizontal"
                                            Margin="0,5,0,0">
                                    <TextBlock Text="{Binding DataSourceInfo}"
                                               Style="{DynamicResource DefaultTextStyle}" />
                                    <TextBlock Text=" | "
                                               Style="{DynamicResource DefaultTextStyle}"
                                               Foreground="{DynamicResource DividerBrush}"
                                               Margin="5,0" />
                                    <TextBlock Text="{Binding MatchInfo}"
                                               Style="{DynamicResource DefaultTextStyle}"
                                               Foreground="{DynamicResource TertiaryTextBrush}"
                                               FontSize="12" />
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                    <!-- 中医信息区域 -->
                    <Border behaviors:ThemeBehavior.Background="{DynamicResource PrimaryThemedCardBackgroundBrush}"
                            BorderBrush="{DynamicResource PrimaryThemedCardBorderBrush}"
                            BorderThickness="1"
                            CornerRadius="6"
                            Padding="10"
                            Margin="0,10"
                            Effect="{DynamicResource CardShadowEffect}"
                            Visibility="{Binding TcmDisease, Converter={StaticResource BooleanToVisibilityConverter}}">
                        
                            <Grid Margin="10,0"
                                  MaxWidth="900">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <!-- 中医病名 -->
                                <TextBlock Grid.Row="0" Grid.Column="0"
                                           Text="中医病名:"
                                           Style="{DynamicResource DefaultTextStyle}"
                                           FontWeight="SemiBold" FontSize="16"
                                           Foreground="{DynamicResource Heading5Brush}"
                                           Visibility="{Binding TcmDisease, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                <TextBlock Grid.Row="1" Grid.Column="0"
                                           Text="{Binding TcmDisease}"
                                           Style="{DynamicResource DefaultTextStyle}"
                                           Margin="60,5,0,0"
                                           TextWrapping="Wrap"
                                           Visibility="{Binding TcmDisease, Converter={StaticResource BooleanToVisibilityConverter}}" />

                                <!-- 中医辨证 -->
                                <TextBlock Grid.Row="0" Grid.Column="1"
                                           Text="中医辨证:"
                                           Style="{DynamicResource DefaultTextStyle}"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource Heading5Brush}"
                                           Margin="0,5,0,0"
                                           Visibility="{Binding TcmSyndrome, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                <TextBlock Grid.Row="1" Grid.Column="1"
                                           Text="{Binding TcmSyndrome}"
                                           Style="{DynamicResource DefaultTextStyle}"
                                           Margin="60,5,0,0"
                                           TextWrapping="Wrap"
                                           Visibility="{Binding TcmSyndrome, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            </Grid>
                        
                    </Border>

                    <!-- 详细信息选项卡 - 使用动态加载 -->
                    <Border behaviors:ThemeBehavior.Background="{DynamicResource WindowBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="6"
                            Padding="8,16"
                            Effect="{DynamicResource CardShadowEffect}">
                        <TabControl x:Name="DrugInfoTab"
                                    HorizontalAlignment="Stretch"
                                    ItemsSource="{Binding TabItems}"
                                    SelectedItem="{Binding SelectedTab}"
                                    ContentTemplateSelector="{StaticResource TabContentSelector}">

                            <TabControl.ItemTemplate>
                                <DataTemplate DataType="{x:Type viewModels:TabItemViewModel}">
                                    <TextBlock Text="{Binding Header}" />
                                </DataTemplate>
                            </TabControl.ItemTemplate>
                        </TabControl>
                    </Border>

                    <!-- 剂量计算器 - 保持原有内容 -->
                    <Grid Margin="0,10">
                        <Grid.Style>
                            <Style TargetType="Grid">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding SelectedTab.Key,FallbackValue={x:Null}}"
                                                 Value="Dosage">
                                        <Setter Property="Visibility" Value="Visible"></Setter>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>
                        <!-- 剂量计算器 - 直接使用ViewModel属性 -->

                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <!-- 计算器选择和状态 -->
                        <Border Grid.Row="0"
                                Background="{DynamicResource CardBackgroundBrush}"
                                BorderBrush="{DynamicResource CardBorderBrush}"
                                BorderThickness="1"
                                CornerRadius="6"
                                Padding="15"
                                Margin="0,0,0,10"
                                Effect="{DynamicResource CardShadowEffect}">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <!-- 标题和操作按钮 -->
                                <Grid Grid.Row="0">
                                    <Grid.RowDefinitions>
                                        <RowDefinition />
                                        <RowDefinition />
                                        <RowDefinition />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0"
                                               Text="剂量计算器"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               VerticalAlignment="Center"
                                               Foreground="{DynamicResource Heading4Brush}" />

                                    <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal">
                                        <Button Content="创建计算器"
                                                Command="{Binding CreateCalculatorCommand}"
                                                Style="{DynamicResource BaseButtonStyle}"
                                                Visibility="{Binding HasCalculators, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                        <Button Content="编辑计算器"
                                                Command="{Binding EditCalculatorCommand}"
                                                Style="{DynamicResource BaseButtonStyle}"
                                                IsEnabled="{Binding SelectedCalculator, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Visibility="{Binding HasCalculators, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Margin="10,0,0,0" />
                                        <Button Content="AI生成计算器"
                                                Command="{Binding GenerateCalculatorWithAiCommand}"
                                                Style="{DynamicResource BaseButtonStyle}"
                                                IsEnabled="{Binding SelectedCalculator, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Visibility="{Binding HasCalculators, Converter={StaticResource InverseBooleanToVisibilityConverter}}"
                                                Margin="10,0,0,0" />
                                    </StackPanel>

                                    <!-- 添加生成进度面板 -->
                                    <!-- 在AI生成进度面板中添加思维链显示 -->
                                    <Border Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                            Background="{DynamicResource InfoCardBackgroundBrush}"
                                            BorderBrush="{DynamicResource InfoCardBorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="6"
                                            Padding="15"
                                            Margin="0,10,0,0"
                                            Visibility="{Binding IsGeneratingCalculator, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <!-- 状态文本 -->
                                            <TextBlock Grid.Row="0"
                                                       Text="{Binding GenerationStatus}"
                                                       FontSize="14"
                                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                                       Margin="0,0,0,10" />

                                            <!-- 进度条 -->
                                            <ProgressBar Grid.Row="1"
                                                         Value="{Binding GenerationProgress}"
                                                         Maximum="100"
                                                         Height="8"
                                                         Foreground="{DynamicResource PrimaryBrush}"
                                                         Background="{DynamicResource SecondaryBackgroundBrush}" />

                                            <!-- 百分比显示 -->
                                            <TextBlock Grid.Row="2"
                                                       Text="{Binding GenerationProgress, StringFormat='{}{0}%'}"
                                                       FontSize="12"
                                                       Foreground="{DynamicResource SecondaryTextBrush}"
                                                       HorizontalAlignment="Right"
                                                       Margin="0,5,0,0" />
                                            <StackPanel Grid.Row="3"
                                                        Visibility="{Binding GenerationReasoningContent, Converter={StaticResource BooleanToVisibilityConverter}}">

                                                <!-- 思维链标题 -->
                                                <TextBlock Text="AI思考过程:"
                                                           FontSize="12"
                                                           FontWeight="SemiBold"
                                                           Foreground="{DynamicResource Heading6Brush}"
                                                           Margin="0,10,0,5" />

                                                <!-- 思维链内容 -->
                                                <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                                                        BorderBrush="{DynamicResource BorderBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="4">
                                                    <markdig:MarkdownViewer
                                                        Markdown="{Binding GenerationReasoningContent,Mode=OneWay}"
                                                        Background="Transparent"
                                                        BorderThickness="0"
                                                        FontSize="11"
                                                        Foreground="{DynamicResource SecondaryTextBrush}"
                                                        FontFamily="Consolas, Microsoft YaHei"
                                                        Padding="10" />
                                                </Border>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </Grid>

                                <!-- 计算器选择 -->
                                <ComboBox Grid.Row="1"
                                          ItemsSource="{Binding AvailableCalculators}"
                                          SelectedItem="{Binding SelectedCalculator}"
                                          DisplayMemberPath="CalculatorName"
                                          MinWidth="200"
                                          Style="{DynamicResource FluentComboBoxStyle}"
                                          HorizontalAlignment="Left"
                                          Margin="0,10,0,0"
                                          Visibility="{Binding HasCalculators, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <i:Interaction.Triggers>
                                        <i:EventTrigger EventName="SelectionChanged">
                                            <i:InvokeCommandAction
                                                Command="{Binding LoadCalculatorParametersCommand}" />
                                        </i:EventTrigger>
                                    </i:Interaction.Triggers>
                                </ComboBox>

                                <!-- 状态信息 -->
                                <StackPanel Grid.Row="2" Orientation="Horizontal"
                                            Margin="0,10,0,0">
                                    <TextBlock Text="{Binding CalculatorStatusMessage}"
                                               Foreground="{DynamicResource SecondaryTextBrush}" />
                                    <ProgressBar Width="20"
                                                 Height="20"
                                                 IsIndeterminate="True"
                                                 Margin="10,0,0,0"
                                                 Visibility="{Binding IsCalculatorLoading, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- 参数输入区域 -->
                        <Border Grid.Row="1"
                                Background="{DynamicResource CardBackgroundBrush}"
                                BorderBrush="{DynamicResource CardBorderBrush}"
                                BorderThickness="1"
                                CornerRadius="6"
                                Padding="15"
                                Margin="0,0,0,10"
                                Effect="{DynamicResource CardShadowEffect}"
                                Visibility="{Binding CalculatorParameters.Count, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <!-- 参数标题 -->
                                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="计算参数 "
                                               FontSize="14"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource Heading5Brush}" />
                                    <TextBlock Text="("
                                               FontSize="14"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource SecondaryTextBrush}" />
                                    <TextBlock Text="*"
                                               FontSize="10"
                                               Margin="3,0"
                                               VerticalAlignment="Top"
                                               Foreground="{DynamicResource ErrorBrush}" />
                                    <TextBlock Text="号标记为必填)"
                                               FontSize="14"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource SecondaryTextBrush}" />
                                </StackPanel>
                                <!-- 参数输入 -->
                                <ItemsControl Grid.Row="1"
                                              ItemsSource="{Binding CalculatorParameters}"
                                              ItemTemplateSelector="{StaticResource ParameterTemplateSelector}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Orientation="Horizontal" />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                </ItemsControl>

                                <!-- 计算按钮 -->
                                <StackPanel Grid.Row="2" Orientation="Horizontal"
                                            Margin="0,10,0,0">
                                    <Button Content="计算剂量"
                                            Style="{DynamicResource BaseButtonStyle}"
                                            Command="{Binding CalculateCommand}"
                                            IsEnabled="{Binding IsCalculating, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                                    <Button Content="清空结果"
                                            Style="{DynamicResource BaseButtonStyle}"
                                            Command="{Binding ClearCalculationResultsCommand}"
                                            Visibility="{Binding HasCalculationResults, Converter={StaticResource BooleanToVisibilityConverter}}"
                                            Margin="10,0,0,0" />
                                    <StackPanel Orientation="Horizontal" Margin="10,0,0,0">
                                        <ProgressBar Width="50"
                                                     Height="5"
                                                     IsIndeterminate="True"
                                                     Margin="0,0,10,0"
                                                     Foreground="{DynamicResource PrimaryBrush}"
                                                     Visibility="{Binding IsCalculating, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                        <TextBlock Text="计算中..."
                                                   VerticalAlignment="Center"
                                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                                   Visibility="{Binding IsCalculating, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- 计算结果 -->
                        <Border Grid.Row="2"
                                Background="{DynamicResource CardBackgroundBrush}"
                                BorderBrush="{DynamicResource CardBorderBrush}"
                                BorderThickness="1"
                                CornerRadius="6"
                                Padding="15"
                                Effect="{DynamicResource CardShadowEffect}"
                                Visibility="{Binding HasCalculationResults, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>

                                <TextBlock Grid.Row="0"
                                           Text="计算结果"
                                           FontSize="14"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource Heading5Brush}"
                                           Margin="0,0,0,10" />

                                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                    <i:Interaction.Behaviors>
                                        <behaviors:ScrollPropagationBehavior />
                                    </i:Interaction.Behaviors>
                                    <ItemsControl ItemsSource="{Binding CalculationResults}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate
                                                DataType="{x:Type models:DosageCalculationResult}">
                                                <Border
                                                    Background="{DynamicResource SecondaryBackgroundBrush}"
                                                    BorderBrush="{DynamicResource BorderBrush}"
                                                    BorderThickness="1.5"
                                                    CornerRadius="4"
                                                    Padding="12"
                                                    Margin="0,5,0,0">
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Style.Triggers>
                                                                <DataTrigger
                                                                    Binding="{Binding IsWarning}"
                                                                    Value="True">
                                                                    <Setter
                                                                        Property="Background"
                                                                        Value="{DynamicResource WarningCardBackgroundBrush}" />
                                                                    <Setter
                                                                        Property="BorderBrush"
                                                                        Value="{DynamicResource WarningCardBorderBrush}" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>

                                                    <Grid>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto" />
                                                            <RowDefinition Height="Auto" />
                                                            <RowDefinition Height="Auto" />
                                                            <RowDefinition Height="Auto" />
                                                        </Grid.RowDefinitions>

                                                        <!-- 描述 -->
                                                        <TextBlock Grid.Row="0"
                                                                   Text="{Binding Description}"
                                                                   VerticalAlignment="Center"
                                                                   FontWeight="SemiBold"
                                                                   FontSize="14"
                                                                   Foreground="{DynamicResource PrimaryTextBrush}" />

                                                        <!-- 剂量信息 -->
                                                        <StackPanel Grid.Row="1"
                                                                    Orientation="Horizontal"
                                                                    Margin="0,5,0,0">
                                                            <TextBlock Text="剂量: " VerticalAlignment="Center"
                                                                       Foreground="{DynamicResource SecondaryTextBrush}" />
                                                            <TextBlock Text="{Binding Dose}" VerticalAlignment="Center"
                                                                       FontWeight="SemiBold"
                                                                       FontSize="16"
                                                                       Foreground="{DynamicResource PrimaryBrush}" />
                                                            <TextBlock Text="{Binding Unit}" VerticalAlignment="Center"
                                                                       Margin="2,0,0,0"
                                                                       FontWeight="SemiBold"
                                                                       Foreground="{DynamicResource PrimaryBrush}" />
                                                            <TextBlock Text=" | " VerticalAlignment="Center"
                                                                       Margin="10,0"
                                                                       Foreground="{DynamicResource DividerBrush}" />
                                                            <TextBlock VerticalAlignment="Center"
                                                                       Text="{Binding Frequency}"
                                                                       Foreground="{DynamicResource SecondaryTextBrush}" />
                                                        </StackPanel>

                                                        <!-- 疗程 -->
                                                        <TextBlock Grid.Row="2"
                                                                   Text="{Binding Duration}"
                                                                   Margin="0,2,0,0"
                                                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                                                   Visibility="{Binding Duration, Converter={StaticResource BooleanToVisibilityConverter}}" />

                                                        <!-- 警告和备注 -->
                                                        <StackPanel Grid.Row="3"
                                                                    Margin="0,5,0,0">
                                                            <TextBlock
                                                                Text="{Binding WarningMessage}"
                                                                Foreground="{DynamicResource WarningTextBrush}"
                                                                FontWeight="SemiBold"
                                                                TextWrapping="Wrap"
                                                                Visibility="{Binding IsWarning, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                                            <TextBlock Text="{Binding Notes}"
                                                                       Foreground="{DynamicResource SecondaryTextBrush}"
                                                                       TextWrapping="Wrap"
                                                                       Margin="0,3,0,0"
                                                                       Visibility="{Binding Notes, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </Grid>
                        </Border>
                    </Grid>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>