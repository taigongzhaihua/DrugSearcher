<Page x:Class="DrugSearcher.Views.HomePage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
      xmlns:markdig="clr-namespace:Markdig.Wpf;assembly=Markdig.Wpf"
      xmlns:viewModels="clr-namespace:DrugSearcher.ViewModels"
      xmlns:converters="clr-namespace:DrugSearcher.Converters"
      xmlns:behaviors="clr-namespace:DrugSearcher.Behaviors"
      xmlns:models="clr-namespace:DrugSearcher.Models"
      mc:Ignorable="d"
      d:DesignHeight="600" d:DesignWidth="1000" d:DataContext="{viewModels:HomePageViewModel}"
      Title="药物查询">

    <Page.Resources>
        <Style TargetType="ListBoxItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border x:Name="Border"
                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                CornerRadius="4" Margin="4"
                                BorderThickness="1"
                                BorderBrush="Transparent">
                            <Grid>
                                <ContentPresenter HorizontalAlignment="Stretch" />
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="BorderBrush"
                                        Value="{DynamicResource PrimaryHoverBrush}" />
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Border" Property="Background"
                                        Value="{DynamicResource BackgroundBrush}" />
                                <Setter TargetName="Border" Property="BorderBrush"
                                        Value="{DynamicResource PrimaryBrush}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 转换器 -->
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter" />
        <converters:ListToStringConverter x:Key="ListToStringConverter" />
    </Page.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- 搜索区域 -->
        <Border Grid.Row="0"
                behaviors:ThemeBehavior.Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="20"
                Margin="0,0,0,20">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- 搜索框和按钮 -->
                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- 搜索输入框 -->
                    <TextBox Grid.Column="0"
                             Text="{Binding SearchTerm, UpdateSourceTrigger=PropertyChanged}"
                             Tag="请输入药物名称、通用名或批准文号"
                             Style="{StaticResource BaseTextBoxStyle}">
                        <i:Interaction.Behaviors>
                            <behaviors:KeyDownBehavior Key="Enter" Command="{Binding SearchCommand}" />
                        </i:Interaction.Behaviors>
                    </TextBox>

                    <!-- 搜索按钮 -->
                    <Button Grid.Column="1"
                            Content="搜索"
                            Style="{StaticResource BaseButtonStyle}"
                            Margin="10,0,0,0"
                            Command="{Binding SearchCommand}"
                            IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                </Grid>

                <!-- 数据源选择 -->
                <StackPanel Grid.Row="1"
                            Orientation="Horizontal"
                            Margin="0,15,0,0">
                    <CheckBox Content="本地数据库"
                              IsChecked="{Binding IsLocalDbEnabled}"
                              Margin="0,0,20,0"
                              Foreground="{DynamicResource PrimaryTextBrush}" />
                    <CheckBox Content="在线数据"
                              IsChecked="{Binding IsOnlineEnabled}"
                              Margin="0,0,20,0"
                              Foreground="{DynamicResource PrimaryTextBrush}" />
                    <TextBlock Text="注: 在线数据包含本地缓存和实时爬取数据"
                               FontSize="11"
                               Foreground="{DynamicResource SecondaryTextBrush}"
                               VerticalAlignment="Center" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- 搜索结果区域 -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- 搜索结果列表 -->
            <Border Grid.Column="0"
                    behaviors:ThemeBehavior.Background="{DynamicResource SurfaceBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Margin="0,0,10,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- 结果统计 -->
                    <Border Grid.Row="0"
                            Background="{DynamicResource SecondaryBackgroundBrush}"
                            Padding="15,10">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding ResultCount}"
                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                       FontWeight="SemiBold" />
                            <TextBlock Text="{Binding SearchStatus}"
                                       Foreground="{DynamicResource SecondaryTextBrush}"
                                       Margin="20,0,0,0" />
                        </StackPanel>
                    </Border>

                    <!-- 结果列表 -->
                    <ListBox Grid.Row="1"
                             ItemsSource="{Binding SearchResults}"
                             SelectedItem="{Binding SelectedDrug}"
                             Background="Transparent"
                             BorderThickness="0"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                             Width="350">
                        <i:Interaction.Triggers>
                            <i:EventTrigger EventName="SelectionChanged">
                                <i:InvokeCommandAction Command="{Binding SelectDrugCommand}"
                                                       CommandParameter="{Binding SelectedDrug}" />
                            </i:EventTrigger>
                        </i:Interaction.Triggers>
                        <ListBox.ItemTemplate>
                            <DataTemplate DataType="{x:Type models:UnifiedDrugSearchResult}">
                                <Grid Margin="10,5">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!-- 药物名称 -->
                                    <TextBlock Grid.Column="0" Grid.Row="0"
                                               Text="{Binding DrugInfo.DisplayName}"
                                               FontWeight="SemiBold"
                                               FontSize="14" LineHeight="18"
                                               Foreground="{DynamicResource PrimaryTextBrush}" />

                                    <!-- 数据源标识 -->
                                    <Border Grid.Column="1" Grid.Row="0"
                                            Background="{Binding DrugInfo.DataSourceColor}"
                                            CornerRadius="4" Padding="8,2"
                                            VerticalAlignment="Center" HorizontalAlignment="Right">
                                        <TextBlock Text="{Binding DrugInfo.DataSourceText}"
                                                   FontSize="9" LineHeight="13"
                                                   Foreground="White" />
                                    </Border>

                                    <!-- 规格和制造商 -->
                                    <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                          HorizontalAlignment="Stretch"
                                          Margin="0,3,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="3*" />
                                            <ColumnDefinition Width="5*" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0"
                                                   Text="{Binding DrugInfo.Specification}"
                                                   FontSize="12" LineHeight="18"
                                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                                   HorizontalAlignment="Left"
                                                   MaxWidth="120"
                                                   TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" />
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding DrugInfo.Manufacturer}"
                                                   FontSize="12" LineHeight="18"
                                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                                   HorizontalAlignment="Right"
                                                   MaxWidth="200"
                                                   TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" />
                                    </Grid>

                                    <!-- 匹配信息 -->
                                    <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                                Orientation="Horizontal"
                                                Margin="0,3,0,0">
                                        <TextBlock Text="{Binding MatchScore, StringFormat=匹配度: {0:P1}}"
                                                   FontSize="10" LineHeight="14"
                                                   Foreground="{DynamicResource AccentBrush}" />
                                        <TextBlock Text=" | "
                                                   FontSize="10" LineHeight="14"
                                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                                   Margin="5,0" />
                                        <TextBlock FontSize="10" LineHeight="14"
                                                   Foreground="{DynamicResource SecondaryTextBrush}">
                                            <TextBlock.Text>
                                                <MultiBinding StringFormat="匹配: {0}">
                                                    <Binding Path="MatchedFields"
                                                             Converter="{StaticResource ListToStringConverter}" />
                                                </MultiBinding>
                                            </TextBlock.Text>
                                        </TextBlock>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- 加载指示器 -->
                    <ProgressBar Grid.Row="2"
                                 IsIndeterminate="True"
                                 Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                                 Height="4" />
                </Grid>
            </Border>

            <!-- 药物详情显示 -->
            <Border Grid.Column="1"
                    behaviors:ThemeBehavior.Background="{DynamicResource SurfaceBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Margin="10,0,0,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto"
                              Padding="20">
                    <StackPanel>
                        <!-- 默认提示 -->
                        <TextBlock Text="请在左侧搜索并选择药物以查看详细信息"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                   FontSize="16"
                                   Margin="0,100,0,0"
                                   Visibility="{Binding IsDetailPanelVisible, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />

                        <!-- 药物详情内容 -->
                        <StackPanel
                            Visibility="{Binding IsDetailPanelVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <!-- 基本信息 -->
                            <TextBlock Text="基本信息"
                                       FontSize="20"
                                       FontWeight="Bold"
                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                       Margin="0,0,0,15" />

                            <StackPanel Margin="0,0,0,20"
                                        MaxWidth="900">

                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Width="120"
                                               Visibility="{Binding DrugName,Converter={StaticResource BooleanToVisibilityConverter}}"
                                               Text="药品名称:"
                                               FontWeight="SemiBold"
                                               Style="{DynamicResource DefaultTextStyle}" />
                                    <TextBlock
                                        Visibility="{Binding DrugName,Converter={StaticResource BooleanToVisibilityConverter}}"
                                        Text="{Binding DrugName}"
                                        Style="{DynamicResource DefaultTextStyle}"
                                        TextWrapping="Wrap" />
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Width="120"
                                               Visibility="{Binding ApprovalNumber,Converter={StaticResource BooleanToVisibilityConverter}}"
                                               Text="批准文号:"
                                               FontWeight="SemiBold"
                                               Style="{DynamicResource DefaultTextStyle}" />
                                    <TextBlock
                                        Visibility="{Binding ApprovalNumber,Converter={StaticResource BooleanToVisibilityConverter}}"
                                        Text="{Binding ApprovalNumber}"
                                        Style="{DynamicResource DefaultTextStyle}"
                                        TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" />
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Width="120"
                                               Visibility="{Binding GenericName,Converter={StaticResource BooleanToVisibilityConverter}}"
                                               Text="通用名称:"
                                               FontWeight="SemiBold"
                                               Style="{DynamicResource DefaultTextStyle}"
                                               Margin="0,5,0,0" />
                                    <TextBlock
                                        Visibility="{Binding GenericName,Converter={StaticResource BooleanToVisibilityConverter}}"
                                        Text="{Binding GenericName}"
                                        Style="{DynamicResource DefaultTextStyle}"
                                        Margin="0,5,0,0"
                                        TextWrapping="Wrap" />
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Width="120"
                                               Visibility="{Binding TradeName,Converter={StaticResource BooleanToVisibilityConverter}}"
                                               Text="商品名称:"
                                               FontWeight="SemiBold"
                                               Style="{DynamicResource DefaultTextStyle}"
                                               Margin="0,5,0,0" />
                                    <TextBlock
                                        Visibility="{Binding TradeName,Converter={StaticResource BooleanToVisibilityConverter}}"
                                        Text="{Binding TradeName}"
                                        Style="{DynamicResource DefaultTextStyle}"
                                        Margin="0,5,0,0"
                                        TextWrapping="Wrap" />
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Width="120"
                                               Visibility="{Binding ManufacturerInfo,Converter={StaticResource BooleanToVisibilityConverter}}"
                                               Text="生产厂家:"
                                               FontWeight="SemiBold"
                                               Style="{DynamicResource DefaultTextStyle}"
                                               Margin="0,5,0,0" />
                                    <TextBlock
                                        Visibility="{Binding ManufacturerInfo,Converter={StaticResource BooleanToVisibilityConverter}}"
                                        Text="{Binding ManufacturerInfo}"
                                        Style="{DynamicResource DefaultTextStyle}"
                                        Margin="0,5,0,0"
                                        TextWrapping="Wrap" />
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Width="120"
                                               Visibility="{Binding Specification,Converter={StaticResource BooleanToVisibilityConverter}}"
                                               Text="规格:"
                                               FontWeight="SemiBold"
                                               Style="{DynamicResource DefaultTextStyle}"
                                               Margin="0,5,0,0" />
                                    <TextBlock
                                        Visibility="{Binding Specification,Converter={StaticResource BooleanToVisibilityConverter}}"
                                        Text="{Binding Specification}"
                                        Style="{DynamicResource DefaultTextStyle}"
                                        Margin="0,5,0,0"
                                        TextWrapping="Wrap" />
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Width="120"
                                               Text="数据来源:"
                                               FontWeight="SemiBold"
                                               Style="{DynamicResource DefaultTextStyle}"
                                               Margin="0,5,0,0" />
                                    <StackPanel Orientation="Horizontal"
                                                Margin="0,5,0,0">
                                        <TextBlock Text="{Binding DataSourceInfo}"
                                                   Style="{DynamicResource DefaultTextStyle}" />
                                        <TextBlock Text=" | "
                                                   Style="{DynamicResource DefaultTextStyle}"
                                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                                   Margin="5,0" />
                                        <TextBlock Text="{Binding MatchInfo}"
                                                   Style="{DynamicResource DefaultTextStyle}"
                                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                                   FontSize="12" />
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>

                            <!-- 中医信息区域 -->
                            <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="6"
                                    Padding="10" MaxWidth="900"
                                    Margin="0,0,0,20"
                                    Visibility="{Binding TcmDisease, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <StackPanel>
                                    <Grid Margin="10,0">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <!-- 中医病名 -->
                                        <TextBlock Grid.Row="0" Grid.Column="0"
                                                   Text="中医病名:"
                                                   Style="{DynamicResource DefaultTextStyle}"
                                                   FontWeight="SemiBold" FontSize="16"
                                                   Visibility="{Binding TcmDisease, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                        <TextBlock Grid.Row="1" Grid.Column="0"
                                                   Text="{Binding TcmDisease}"
                                                   Style="{DynamicResource DefaultTextStyle}"
                                                   Margin="60,5,0,0"
                                                   TextWrapping="Wrap"
                                                   Visibility="{Binding TcmDisease, Converter={StaticResource BooleanToVisibilityConverter}}" />

                                        <!-- 中医辨证 -->
                                        <TextBlock Grid.Row="0" Grid.Column="1"
                                                   Text="中医辨证:"
                                                   Style="{DynamicResource DefaultTextStyle}"
                                                   FontWeight="SemiBold"
                                                   Margin="0,5,0,0"
                                                   Visibility="{Binding TcmSyndrome, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                        <TextBlock Grid.Row="1" Grid.Column="1"
                                                   Text="{Binding TcmSyndrome}"
                                                   Style="{DynamicResource DefaultTextStyle}"
                                                   Margin="60,5,0,0"
                                                   TextWrapping="Wrap"
                                                   Visibility="{Binding TcmSyndrome, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- 详细信息选项卡 - 使用 Markdown 显示 -->
                            <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="6"
                                    Padding="5,0,5,5" MaxWidth="900"
                                    Margin="0,0,0,20">
                                <TabControl Margin="0,10,0,0"
                                            HorizontalAlignment="Stretch"
                                            MinHeight="400">

                                    <!-- 全部详情 -->
                                    <TabItem Header="📋 全部详情" Style="{StaticResource FluentTabItemStyle}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[FullDetails]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 主要成分 -->
                                    <TabItem Header="🧪 主要成分" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[MainIngredients], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[MainIngredients]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 性状 -->
                                    <TabItem Header="👁️ 性状" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[Appearance], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[Appearance]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 药物说明 -->
                                    <TabItem Header="📋 药物说明" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[DrugDescription], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[DrugDescription]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 适应症 -->
                                    <TabItem Header="🎯 适应症" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[Indications], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[Indications]}"
                                            Background="Transparent" />
                                    </TabItem>


                                    <!-- 用法用量标签页 -->
                                    <TabItem Header="💊 用法用量" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[Dosage], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="*" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="*" />
                                            </Grid.RowDefinitions>

                                            <!-- 原有的用法用量说明 -->
                                            <markdig:MarkdownViewer Grid.Row="0"
                                                                    Markdown="{Binding MarkdownContents[Dosage]}"
                                                                    Background="Transparent" />

                                            <!-- 分隔线 -->
                                            <Separator Grid.Row="1" Margin="0,10" />

                                            <!-- 剂量计算器 - 直接使用ViewModel属性 -->
                                            <Grid Grid.Row="2">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="*" />
                                                </Grid.RowDefinitions>

                                                <!-- 计算器选择和状态 -->
                                                <Border Grid.Row="0"
                                                        Background="{DynamicResource SurfaceBrush}"
                                                        BorderBrush="{DynamicResource BorderBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="6"
                                                        Padding="15"
                                                        Margin="0,0,0,10">
                                                    <Grid>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto" />
                                                            <RowDefinition Height="Auto" />
                                                            <RowDefinition Height="Auto" />
                                                        </Grid.RowDefinitions>

                                                        <!-- 标题和操作按钮 -->
                                                        <Grid Grid.Row="0">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*" />
                                                                <ColumnDefinition Width="Auto" />
                                                            </Grid.ColumnDefinitions>

                                                            <TextBlock Grid.Column="0"
                                                                       Text="剂量计算器"
                                                                       FontSize="16"
                                                                       FontWeight="SemiBold"
                                                                       VerticalAlignment="Center"
                                                                       Foreground="{DynamicResource PrimaryTextBrush}" />

                                                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                                <Button Content="创建计算器"
                                                                        Command="{Binding CreateCalculatorCommand}"
                                                                        Style="{StaticResource BaseButtonStyle}"
                                                                        Visibility="{Binding HasCalculators, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                                                <Button Content="编辑计算器"
                                                                        Command="{Binding EditCalculatorCommand}"
                                                                        Style="{StaticResource BaseButtonStyle}"
                                                                        IsEnabled="{Binding SelectedCalculator, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                        Visibility="{Binding HasCalculators, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                        Margin="10,0,0,0" />
                                                                <Button Content="AI生成计算器"
                                                                        Command="{Binding GenerateCalculatorWithAiCommand}"
                                                                        Style="{StaticResource BaseButtonStyle}"
                                                                        IsEnabled="{Binding SelectedCalculator, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                        Visibility="{Binding HasCalculators, Converter={StaticResource InverseBooleanToVisibilityConverter}}"
                                                                        Margin="10,0,0,0"/>
                                                            </StackPanel>
                                                        </Grid>

                                                        <!-- 计算器选择 -->
                                                        <ComboBox Grid.Row="1"
                                                                  ItemsSource="{Binding AvailableCalculators}"
                                                                  SelectedItem="{Binding SelectedCalculator}"
                                                                  DisplayMemberPath="CalculatorName"
                                                                  MinWidth="200"
                                                                  HorizontalAlignment="Left"
                                                                  Margin="0,10,0,0"
                                                                  Visibility="{Binding HasCalculators, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                            <i:Interaction.Triggers>
                                                                <i:EventTrigger EventName="SelectionChanged">
                                                                    <i:InvokeCommandAction
                                                                        Command="{Binding LoadCalculatorParametersCommand}" />
                                                                </i:EventTrigger>
                                                            </i:Interaction.Triggers>
                                                        </ComboBox>

                                                        <!-- 状态信息 -->
                                                        <StackPanel Grid.Row="2" Orientation="Horizontal"
                                                                    Margin="0,10,0,0">
                                                            <TextBlock Text="{Binding CalculatorStatusMessage}"
                                                                       Foreground="{DynamicResource SecondaryTextBrush}" />
                                                            <ProgressBar Width="20"
                                                                         Height="20"
                                                                         IsIndeterminate="True"
                                                                         Margin="10,0,0,0"
                                                                         Visibility="{Binding IsCalculatorLoading, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>

                                                <!-- 参数输入区域 -->
                                                <Border Grid.Row="1"
                                                        Background="{DynamicResource SurfaceBrush}"
                                                        BorderBrush="{DynamicResource BorderBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="6"
                                                        Padding="15"
                                                        Margin="0,0,0,10"
                                                        Visibility="{Binding CalculatorParameters.Count, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                    <Grid>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto" />
                                                            <RowDefinition Height="Auto" />
                                                            <RowDefinition Height="Auto" />
                                                        </Grid.RowDefinitions>

                                                        <!-- 参数标题 -->
                                                        <TextBlock Grid.Row="0"
                                                                   Text="计算参数( "
                                                                   FontSize="14"
                                                                   FontWeight="SemiBold"
                                                                   Foreground="{DynamicResource PrimaryTextBrush}"
                                                                   Margin="0,0,0,10" />

                                                        <!-- 参数输入 -->
                                                        <ItemsControl Grid.Row="1"
                                                                      ItemsSource="{Binding CalculatorParameters}">
                                                            <ItemsControl.ItemsPanel>
                                                                <ItemsPanelTemplate>
                                                                    <WrapPanel Orientation="Horizontal" />
                                                                </ItemsPanelTemplate>
                                                            </ItemsControl.ItemsPanel>
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate
                                                                    DataType="{x:Type models:DosageParameter}">
                                                                    <Border BorderBrush="{DynamicResource BorderBrush}"
                                                                            BorderThickness="1"
                                                                            CornerRadius="4"
                                                                            Padding="10,10,5,10"
                                                                            Margin="0,0,15,10"
                                                                            Background="{DynamicResource BackgroundBrush}">
                                                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                                            <StackPanel Orientation="Horizontal">
                                                                                <TextBlock Text="{Binding DisplayName}"
                                                                                    FontWeight="SemiBold" VerticalAlignment="Center"
                                                                                    Margin="0,0,0,5" />
                                                                                <TextBlock Text="*" VerticalAlignment="Top"
                                                                                    FontSize="10" Margin="5,10"
                                                                                    Foreground="{DynamicResource ErrorBrush}"
                                                                                    Visibility="{Binding IsRequired, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                                                            </StackPanel>

                                                                            <TextBox
                                                                                Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                                                                Style="{StaticResource BaseTextBoxStyle}"
                                                                                MinWidth="50"
                                                                                ToolTip="{Binding Description}" />
                                                                            <TextBlock Text="{Binding Unit}"
                                                                                FontSize="14" VerticalAlignment="Center"
                                                                                Margin="10,5,5,5"
                                                                                Foreground="{DynamicResource SecondaryTextBrush}" />

                                                                        </StackPanel>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>

                                                        <!-- 计算按钮 -->
                                                        <StackPanel Grid.Row="2" Orientation="Horizontal"
                                                                    Margin="0,10,0,0">
                                                            <Button Content="计算剂量"
                                                                    Style="{StaticResource BaseButtonStyle}"
                                                                    Command="{Binding CalculateCommand}"
                                                                    IsEnabled="{Binding IsCalculating, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                                                            <Button Content="清空结果"
                                                                    Style="{StaticResource BaseButtonStyle}"
                                                                    Command="{Binding ClearCalculationResultsCommand}"
                                                                    Visibility="{Binding HasCalculationResults, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                    Margin="10,0,0,0" />
                                                            <StackPanel Orientation="Horizontal" Margin="10,0,0,0">
                                                                <ProgressBar Width="20"
                                                                             Height="20"
                                                                             IsIndeterminate="True"
                                                                             Margin="0,0,10,0"
                                                                             Visibility="{Binding IsCalculating, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                                                <TextBlock Text="计算中..."
                                                                           VerticalAlignment="Center"
                                                                           Foreground="{DynamicResource SecondaryTextBrush}"
                                                                           Visibility="{Binding IsCalculating, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                                            </StackPanel>
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>

                                                <!-- 计算结果 -->
                                                <Border Grid.Row="2"
                                                        Background="{DynamicResource SurfaceBrush}"
                                                        BorderBrush="{DynamicResource BorderBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="6"
                                                        Padding="15"
                                                        Visibility="{Binding HasCalculationResults, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                    <Grid>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto" />
                                                            <RowDefinition Height="*" />
                                                        </Grid.RowDefinitions>

                                                        <TextBlock Grid.Row="0"
                                                                   Text="计算结果"
                                                                   FontSize="14"
                                                                   FontWeight="SemiBold"
                                                                   Foreground="{DynamicResource PrimaryTextBrush}"
                                                                   Margin="0,0,0,10" />

                                                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                                            <ItemsControl ItemsSource="{Binding CalculationResults}">
                                                                <ItemsControl.ItemTemplate>
                                                                    <DataTemplate
                                                                        DataType="{x:Type models:DosageCalculationResult}">
                                                                        <Border
                                                                            Background="{DynamicResource SecondaryBackgroundBrush}"
                                                                            BorderBrush="{DynamicResource BorderBrush}"
                                                                            BorderThickness="1"
                                                                            CornerRadius="4"
                                                                            Padding="12"
                                                                            Margin="0,5,0,0">
                                                                            <Border.Style>
                                                                                <Style TargetType="Border">
                                                                                    <Style.Triggers>
                                                                                        <DataTrigger
                                                                                            Binding="{Binding IsWarning}"
                                                                                            Value="True">
                                                                                            <Setter
                                                                                                Property="BorderBrush"
                                                                                                Value="#FF6B47" />
                                                                                            <Setter
                                                                                                Property="Background"
                                                                                                Value="#FFF3F0" />
                                                                                        </DataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </Border.Style>

                                                                            <Grid>
                                                                                <Grid.RowDefinitions>
                                                                                    <RowDefinition Height="Auto" />
                                                                                    <RowDefinition Height="Auto" />
                                                                                    <RowDefinition Height="Auto" />
                                                                                    <RowDefinition Height="Auto" />
                                                                                </Grid.RowDefinitions>

                                                                                <!-- 描述 -->
                                                                                <TextBlock Grid.Row="0"
                                                                                    Text="{Binding Description}"
                                                                                    FontWeight="SemiBold"
                                                                                    FontSize="14"
                                                                                    Foreground="{DynamicResource PrimaryTextBrush}" />

                                                                                <!-- 剂量信息 -->
                                                                                <StackPanel Grid.Row="1"
                                                                                    Orientation="Horizontal"
                                                                                    Margin="0,5,0,0">
                                                                                    <TextBlock Text="剂量: "
                                                                                        Foreground="{DynamicResource SecondaryTextBrush}" />
                                                                                    <TextBlock Text="{Binding Dose}"
                                                                                        FontWeight="SemiBold"
                                                                                        FontSize="16"
                                                                                        Foreground="{DynamicResource PrimaryTextBrush}" />
                                                                                    <TextBlock Text="{Binding Unit}"
                                                                                        Margin="2,0,0,0"
                                                                                        FontWeight="SemiBold"
                                                                                        Foreground="{DynamicResource PrimaryTextBrush}" />
                                                                                    <TextBlock Text=" | "
                                                                                        Margin="10,0"
                                                                                        Foreground="{DynamicResource SecondaryTextBrush}" />
                                                                                    <TextBlock
                                                                                        Text="{Binding Frequency}"
                                                                                        Foreground="{DynamicResource SecondaryTextBrush}" />
                                                                                </StackPanel>

                                                                                <!-- 疗程 -->
                                                                                <TextBlock Grid.Row="2"
                                                                                    Text="{Binding Duration}"
                                                                                    Margin="0,2,0,0"
                                                                                    Foreground="{DynamicResource SecondaryTextBrush}"
                                                                                    Visibility="{Binding Duration, Converter={StaticResource BooleanToVisibilityConverter}}" />

                                                                                <!-- 警告和备注 -->
                                                                                <StackPanel Grid.Row="3"
                                                                                    Margin="0,5,0,0">
                                                                                    <TextBlock
                                                                                        Text="{Binding WarningMessage}"
                                                                                        Foreground="#FF6B47"
                                                                                        FontWeight="SemiBold"
                                                                                        TextWrapping="Wrap"
                                                                                        Visibility="{Binding IsWarning, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                                                                    <TextBlock Text="{Binding Notes}"
                                                                                        Foreground="{DynamicResource SecondaryTextBrush}"
                                                                                        TextWrapping="Wrap"
                                                                                        Margin="0,3,0,0"
                                                                                        Visibility="{Binding Notes, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                                                                </StackPanel>
                                                                            </Grid>
                                                                        </Border>
                                                                    </DataTemplate>
                                                                </ItemsControl.ItemTemplate>
                                                            </ItemsControl>
                                                        </ScrollViewer>
                                                    </Grid>
                                                </Border>
                                            </Grid>
                                        </Grid>
                                    </TabItem>

                                    <!-- 其他标签页保持不变... -->
                                    <!-- 不良反应 -->
                                    <TabItem Header="⚠️ 不良反应" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[SideEffects], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[SideEffects]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 注意事项 -->
                                    <TabItem Header="⚡ 注意事项" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[Precautions], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[Precautions]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 禁忌 -->
                                    <TabItem Header="🚫 禁忌" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[Contraindications], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[Contraindications]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 孕妇及哺乳期妇女用药 -->
                                    <TabItem Header="🤱 孕妇及哺乳期妇女用药" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[PregnancyAndLactation], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[PregnancyAndLactation]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 儿童用药 -->
                                    <TabItem Header="👶 儿童用药" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[PediatricUse], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[PediatricUse]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 老人用药 -->
                                    <TabItem Header="👴 老人用药" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[GeriatricUse], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[GeriatricUse]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 药物相互作用 -->
                                    <TabItem Header="🔄 药物相互作用" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[DrugInteractions], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[DrugInteractions]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 药理毒理 -->
                                    <TabItem Header="🔬 药理毒理" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[Pharmacology], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[Pharmacology]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 药代动力学 -->
                                    <TabItem Header="📈 药代动力学" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[Pharmacokinetics], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[Pharmacokinetics]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 储存信息 -->
                                    <TabItem Header="📦 储存信息" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[Storage], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[Storage]}"
                                            Background="Transparent" />
                                    </TabItem>

                                    <!-- 中医备注 -->
                                    <TabItem Header="🏥 备注" Style="{StaticResource FluentTabItemStyle}"
                                             Visibility="{Binding MarkdownContents[TcmRemarks], Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <markdig:MarkdownViewer
                                            Markdown="{Binding MarkdownContents[TcmRemarks]}"
                                            Background="Transparent" />
                                    </TabItem>
                                </TabControl>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
    </Grid>
</Page>