<UserControl x:Class="DrugSearcher.Views.Controls.DosageCalculatorControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:models="clr-namespace:DrugSearcher.Models"
             xmlns:converters="clr-namespace:DrugSearcher.Converters"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
        
        <Style x:Key="ParameterInputStyle" TargetType="TextBox" BasedOn="{StaticResource BaseTextBoxStyle}">
            <Setter Property="Margin" Value="0,5,0,0"/>
            <Setter Property="MinWidth" Value="120"/>
            <Setter Property="MaxWidth" Value="200"/>
        </Style>
        
        <Style x:Key="ParameterLabelStyle" TargetType="TextBlock">
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,5,10,0"/>
            <Setter Property="MinWidth" Value="80"/>
            <Setter Property="MaxWidth" Value="120"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}"/>
        </Style>
        
        <Style x:Key="ResultItemStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource SecondaryBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Margin" Value="0,5,0,0"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsWarning}" Value="True">
                    <Setter Property="BorderBrush" Value="#FF6B47"/>
                    <Setter Property="Background" Value="#FFF3F0"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 计算器选择和状态 -->
        <Border Grid.Row="0" 
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="6"
                Padding="15"
                Margin="0,0,0,10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- 标题和操作按钮 -->
                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBlock Grid.Column="0"
                               Text="剂量计算器" 
                               FontSize="16" 
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               Foreground="{DynamicResource PrimaryTextBrush}"/>
                    
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Content="创建计算器" 
                                Command="{Binding CreateCalculatorCommand}"
                                Style="{StaticResource BaseButtonStyle}"
                                Visibility="{Binding HasCalculators, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                        <Button Content="编辑计算器" 
                                Command="{Binding EditCalculatorCommand}"
                                Style="{StaticResource BaseButtonStyle}"
                                IsEnabled="{Binding SelectedCalculator, Converter={StaticResource BooleanToVisibilityConverter}}"
                                Visibility="{Binding HasCalculators, Converter={StaticResource BooleanToVisibilityConverter}}"
                                Margin="10,0,0,0"/>
                    </StackPanel>
                </Grid>
                
                <!-- 计算器选择 -->
                <ComboBox Grid.Row="1"
                          ItemsSource="{Binding AvailableCalculators}"
                          SelectedItem="{Binding SelectedCalculator}"
                          DisplayMemberPath="CalculatorName"
                          MinWidth="200"
                          HorizontalAlignment="Left"
                          Margin="0,10,0,0"
                          Visibility="{Binding HasCalculators, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <i:Interaction.Triggers>
                        <i:EventTrigger EventName="SelectionChanged">
                            <i:InvokeCommandAction Command="{Binding LoadCalculatorParametersCommand}"/>
                        </i:EventTrigger>
                    </i:Interaction.Triggers>
                </ComboBox>
                
                <!-- 状态信息 -->
                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,10,0,0">
                    <TextBlock Text="{Binding StatusMessage}" 
                               Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <ProgressBar Width="20" 
                                 Height="20"
                                 IsIndeterminate="True"
                                 Margin="10,0,0,0"
                                 Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 参数输入区域 -->
        <Border Grid.Row="1" 
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="6"
                Padding="15"
                Margin="0,0,0,10"
                Visibility="{Binding SelectedCalculator, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- 参数标题 -->
                <TextBlock Grid.Row="0" 
                           Text="计算参数" 
                           FontSize="14" 
                           FontWeight="SemiBold"
                           Foreground="{DynamicResource PrimaryTextBrush}"
                           Margin="0,0,0,10"/>
                
                <!-- 参数输入 -->
                <ItemsControl Grid.Row="1" 
                              ItemsSource="{Binding Parameters}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type models:DosageParameter}">
                            <Border BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Padding="10"
                                    Margin="0,0,15,10"
                                    Background="{DynamicResource BackgroundBrush}">
                                <StackPanel>
                                    <TextBlock Text="{Binding DisplayName}" 
                                               Style="{StaticResource ParameterLabelStyle}"
                                               FontWeight="SemiBold"
                                               Margin="0,0,0,5"/>
                                    
                                    <TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource ParameterInputStyle}"
                                             ToolTip="{Binding Description}"/>
                                    
                                    <StackPanel Orientation="Horizontal" Margin="0,3,0,0">
                                        <TextBlock Text="{Binding Unit}" 
                                                   FontSize="10"
                                                   Foreground="{DynamicResource SecondaryTextBrush}"/>
                                        <TextBlock Text=" | " 
                                                   FontSize="10"
                                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                                   Visibility="{Binding IsRequired, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                        <TextBlock Text="必填" 
                                                   FontSize="10"
                                                   Foreground="#FF6B47"
                                                   Visibility="{Binding IsRequired, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <!-- 计算按钮 -->
                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,10,0,0">
                    <Button Content="计算剂量" 
                            Style="{StaticResource BaseButtonStyle}"
                            Command="{Binding CalculateCommand}"
                            IsEnabled="{Binding IsCalculating, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                    <Button Content="清空结果" 
                            Style="{StaticResource BaseButtonStyle}"
                            Command="{Binding ClearResultsCommand}"
                            Visibility="{Binding HasResults, Converter={StaticResource BooleanToVisibilityConverter}}"
                            Margin="10,0,0,0"/>
                    <StackPanel Orientation="Horizontal" Margin="10,0,0,0">
                        <ProgressBar Width="20" 
                                     Height="20"
                                     IsIndeterminate="True"
                                     Margin="0,0,10,0"
                                     Visibility="{Binding IsCalculating, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                        <TextBlock Text="计算中..." 
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                   Visibility="{Binding IsCalculating, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 计算结果 -->
        <Border Grid.Row="2" 
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="6"
                Padding="15"
                Visibility="{Binding HasResults, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <TextBlock Grid.Row="0" 
                           Text="计算结果" 
                           FontSize="14" 
                           FontWeight="SemiBold"
                           Foreground="{DynamicResource PrimaryTextBrush}"
                           Margin="0,0,0,10"/>
                
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding CalculationResults}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type models:DosageCalculationResult}">
                                <Border Style="{StaticResource ResultItemStyle}">
                                    
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        
                                        <!-- 描述 -->
                                        <TextBlock Grid.Row="0" 
                                                   Text="{Binding Description}"
                                                   FontWeight="SemiBold"
                                                   FontSize="14"
                                                   Foreground="{DynamicResource PrimaryTextBrush}"/>
                                        
                                        <!-- 剂量信息 -->
                                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,5,0,0">
                                            <TextBlock Text="剂量: " 
                                                       Foreground="{DynamicResource SecondaryTextBrush}"/>
                                            <TextBlock Text="{Binding Dose}" 
                                                       FontWeight="SemiBold"
                                                       FontSize="16"
                                                       Foreground="{DynamicResource PrimaryTextBrush}"/>
                                            <TextBlock Text="{Binding Unit}" 
                                                       Margin="2,0,0,0"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource PrimaryTextBrush}"/>
                                            <TextBlock Text=" | " 
                                                       Margin="10,0"
                                                       Foreground="{DynamicResource SecondaryTextBrush}"/>
                                            <TextBlock Text="{Binding Frequency}" 
                                                       Foreground="{DynamicResource SecondaryTextBrush}"/>
                                        </StackPanel>
                                        
                                        <!-- 疗程 -->
                                        <TextBlock Grid.Row="2" 
                                                   Text="{Binding Duration}"
                                                   Margin="0,2,0,0"
                                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                                   Visibility="{Binding Duration, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                        
                                        <!-- 警告和备注 -->
                                        <StackPanel Grid.Row="3" Margin="0,5,0,0">
                                            <TextBlock Text="{Binding WarningMessage}" 
                                                       Foreground="#FF6B47"
                                                       FontWeight="SemiBold"
                                                       TextWrapping="Wrap"
                                                       Visibility="{Binding IsWarning, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                            <TextBlock Text="{Binding Notes}" 
                                                       Foreground="{DynamicResource SecondaryTextBrush}"
                                                       TextWrapping="Wrap"
                                                       Margin="0,3,0,0"
                                                       Visibility="{Binding Notes, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>